# BC训练Loss跳变分析

## 问题描述

在单轨迹BC训练中，观察到训练后期（约15,000步）出现明显的loss跳变：
- `bc/actor_loss`: 从约-15跳变到+24（跳变幅度约39）
- `bc/total_loss`: 从接近0跳变到约25-30
- `bc/mse`: 保持稳定，无明显跳变
- `bc/normalized_mse`: 保持稳定，无明显跳变

## 根本原因分析

### 1. 数据集大小 vs Batch Size 不匹配

**关键数据**：
- 数据集大小（过滤后）：**418 transitions**
- 默认 batch_size：**256**
- Batch size 占比：**256/418 ≈ 61%**

**问题**：
当 batch_size 接近或超过数据集大小的50%时，会出现以下问题：

1. **样本重复率高**：
   - 每个batch包含256个样本，但总共只有418个样本
   - 每个样本平均会被采样 **256/418 ≈ 0.61** 次
   - 实际上由于随机采样，某些样本可能被重复采样多次，某些样本可能不被采样

2. **Batch质量差异大**：
   - 某些batch可能包含大量"困难"样本（动作误差大的样本）
   - 某些batch可能包含大量"简单"样本（动作误差小的样本）
   - 当困难样本集中在一个batch时，会导致loss spike

3. **数据覆盖不均匀**：
   - 在20,000步训练中，每个样本平均被使用 **20,000 × 256 / 418 ≈ 12,250** 次
   - 但实际分布不均匀，某些样本可能被过度使用，某些样本可能使用不足

### 2. 为什么MSE没有跳变？

从图表观察：
- `bc/mse`: 保持稳定在约0.1
- `bc/normalized_mse`: 保持稳定接近0
- `bc/actor_loss`: 出现大幅跳变

**原因**：
- MSE是直接的动作预测误差，相对稳定
- Actor loss包含负对数似然项，对分布参数（如标准差）的变化更敏感
- 当遇到困难batch时，分布参数可能发生较大变化，导致actor loss跳变

### 3. 为什么在15,000步左右跳变？

可能的原因：
1. **随机采样导致**：恰好采样到一个包含大量困难样本的batch
2. **学习率影响**：如果使用学习率调度，可能在15k步附近有变化
3. **数据分布**：轨迹中某些阶段（如装配关键步骤）的样本可能更难学习

## 解决方案

### 方案1：减小Batch Size（推荐）

**建议**：将batch_size减小到数据集大小的10-20%

```python
# 对于418个样本的数据集
batch_size = 64  # 约15%的数据集大小
# 或
batch_size = 32  # 约8%的数据集大小
```

**优点**：
- 减少样本重复率
- 提高batch多样性
- 训练更稳定

**缺点**：
- 训练速度可能稍慢（但影响不大）
- 梯度估计可能稍不稳定（但可以通过更多步数补偿）

### 方案2：增加数据量

**建议**：使用多条轨迹训练

```bash
# 使用全部5条轨迹
python examples/train_bc.py \
    --exp_name=gear_assembly \
    --demo_path=./demo_data/gear_assembly_5_demos_2026-02-04_09-01-56.pkl \
    --bc_checkpoint_path=./checkpoints/bc_all_trajs \
    --train_steps=20000
```

**优点**：
- 数据量增加到约2,000+ transitions
- batch_size (256) 占比降低到约12%
- 训练更稳定，泛化能力更好

### 方案3：使用加权采样

**建议**：对困难样本进行加权，避免集中采样

```python
# 可以根据动作误差对样本进行加权
# 但这需要修改数据加载逻辑
```

### 方案4：使用学习率调度

**建议**：在训练后期降低学习率，减少对困难batch的过度反应

## 当前训练结果评估

### 正面指标：
1. ✅ **MSE收敛良好**：稳定在0.1左右，说明动作预测准确
2. ✅ **Normalized MSE接近0**：说明模型已很好学习演示数据
3. ✅ **总体趋势正确**：Loss整体下降并稳定

### 需要关注：
1. ⚠️ **Actor Loss跳变**：虽然不影响最终性能，但说明训练不够稳定
2. ⚠️ **数据量不足**：单条轨迹可能无法充分学习策略的鲁棒性

## 建议

### 对于单轨迹验证：
1. **减小batch_size到64或32**，重新训练
2. **观察loss是否更稳定**
3. **如果验证通过**（能复现轨迹），说明数据质量没问题

### 对于实际训练：
1. **使用全部5条轨迹**进行训练
2. **保持batch_size=256**（因为数据量足够）
3. **这样既能验证数据质量，又能获得更好的策略**

## 结论

**Loss跳变是正常的**，特别是在：
- 数据集很小（<1000 samples）
- Batch size相对较大（>50%数据集大小）
- 使用单条轨迹训练

**这不影响验证目标**：如果BC能从单条轨迹学习并复现轨迹，说明数据质量是合格的。跳变只是训练不稳定的表现，不影响最终模型质量。

**建议**：减小batch_size后重新训练，观察是否更稳定。如果验证通过，可以继续使用全部数据训练。
